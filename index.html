<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–èˆˆ-è‡ªå‹•å¡«å–®ç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f6f9; padding: 20px; color: #333; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        .section { margin-bottom: 25px; padding: 20px; background: #fff; border: 1px solid #e1e4e8; border-radius: 8px; }
        .section-title { font-weight: bold; color: #007bff; margin-bottom: 15px; font-size: 1.1em; border-left: 4px solid #007bff; padding-left: 10px; }

        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .grid-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .full-width { grid-column: span 2; }

        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.95em; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 15px; }
        input:focus, textarea:focus { border-color: #007bff; outline: none; background: #f9fcff; }
        textarea { resize: vertical; height: 80px; }

        .auto-field { background-color: #e9ecef; color: #495057; cursor: not-allowed; font-weight: bold; }
        
        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        button { flex: 1; color: white; border: none; padding: 15px; font-size: 18px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }
        
        .btn-deposit { background-color: #17a2b8; }
        .btn-deposit:hover { background-color: #138496; }
        
        .btn-op { background-color: #e67e22; }
        .btn-op:hover { background-color: #d35400; }

        .tag-info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 4px; font-size: 0.9em; margin-bottom: 20px; border: 1px solid #bee5eb; }

        /* ç¥¨æœŸé¸é …æŒ‰éˆ•æ¨£å¼ */
        .ticket-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* å…©åˆ—æ’åˆ— */
            gap: 10px;
            margin-bottom: 15px;
        }
        .ticket-option-label {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            background-color: #fafafa;
            transition: all 0.2s;
        }
        .ticket-option-label:hover {
            background-color: #eef6ff;
            border-color: #007bff;
        }
        .ticket-option-label input {
            width: auto;
            margin-right: 10px;
        }
        .ticket-option-label span {
            font-size: 14px;
            font-weight: bold;
        }
        /* é¸ä¸­ç‹€æ…‹ */
        .ticket-option-label:has(input:checked) {
            background-color: #e7f1ff;
            border-color: #007bff;
            color: #0056b3;
        }
        @media (min-width: 600px) {
            .ticket-options { grid-template-columns: repeat(4, 1fr); } /* å¯¬è¢å¹•è®Šå››åˆ— */
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
</head>
<body>

<div class="container">
    <h1>âœˆï¸ ä¸–èˆˆ-è‡ªå‹•å¡«å–®ç³»çµ±</h1>

    <div class="section">
        <div class="section-title">1. å¿«é€Ÿè²¼ä¸Š (è‡ªå‹•è§£æåœ˜è™Ÿ/æ—¥æœŸ)</div>
        <textarea id="rawInput" placeholder="ç¯„ä¾‹ï¼šæ˜‡ç´šç‰ˆ~æ¸…å·...  CJJ05260206A" oninput="parseRawData()"></textarea>
    </div>

    <div class="section">
        <div class="section-title">2. è©³ç´°è³‡æ–™è¼¸å…¥</div>
        
        <div class="grid-row">
            <div><label>å¡«å–®æ—¥æœŸ</label><input type="date" id="inputFillDate"></div>
            <div><label>åœ˜è™Ÿ</label><input type="text" id="inputGroupCode" class="auto-field" readonly></div>
        </div>

        <div class="grid-row"><div class="full-width"><label>ç”¢å“åç¨±</label><input type="text" id="inputGroupName"></div></div>

        <div class="grid-row">
            <div><label>æ—…è¡Œç¤¾åç¨± ({agency})</label><input type="text" id="inputAgency" value="æ—…è¡Œç¤¾"></div>
            <div><label>AGT åå­— ({agent})</label><input type="text" id="inputAgent" value=""></div>
        </div>

        <div class="grid-row">
            <div><label>èˆªç©ºå…¬å¸</label><input type="text" id="inputAirline" value="èˆªç©º"></div>
            <div><label>è¡Œå‹•é›»è©±</label><input type="text" id="inputMobile" value=""></div>
        </div>

        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 20px 0;">

        <div class="grid-row-3">
            <div><label>å¤§äººäººæ•¸ ({paxAdult})</label><input type="number" id="inputAdults" value="" min="0" oninput="calculateTotal()"></div>
            <div><label>å°å­©äººæ•¸ ({paxChild})</label><input type="number" id="inputChildren" value="" min="0" oninput="calculateTotal()"></div>
            <div><label>ç¸½äººæ•¸ ({paxTotal})</label><input type="number" id="inputPaxTotal" class="auto-field" readonly></div>
        </div>

        <div class="grid-row">
            <div><label>åœ˜è²» ({fee})</label><input type="text" id="inputFee" value=""></div>
            <div><label>æˆåœ˜é–€æª» (äºº)</label><input type="number" id="inputMinPax" value="16"></div>
        </div>

        <div class="grid-row">
            <div><label>æ¯äººè¨‚é‡‘</label><input type="number" id="inputDepositUnit" value="" oninput="calculateTotal()"></div>
            <div><label>è¨‚é‡‘ç¸½é‡‘é¡ (è‡ªå‹•è¨ˆç®—)</label><input type="text" id="outputTotalDeposit" class="auto-field" readonly></div>
        </div>

        <div class="grid-row">
            <div><label>å°è²» (æ¯äººæ¯å¤©)</label><input type="number" id="inputTips" value="300"></div>
            <div><label>è¨‚é‡‘ç¹³äº¤æœŸé™</label><input type="text" id="inputDepositDeadline" placeholder="ä¾‹: 1/15 17:00å‰"></div>
        </div>

        <div class="grid-row"><div class="full-width"><label>å‚™è¨»äº‹é …</label><textarea id="inputRemarks" placeholder="è¼¸å…¥é¡å¤–å‚™è¨»..."></textarea></div></div>
    </div>

    <div class="section">
        <div class="section-title">3. ç¥¨æœŸèˆ‡æ¥­å‹™</div>
        
        <label>ç¥¨æœŸæ¨ç®—è¦å‰‡ (é»é¸è‡ªå‹•è¨ˆç®—)ï¼š</label>
        <div class="ticket-options">
            <label class="ticket-option-label">
                <input type="radio" name="ticketRule" value="normal" checked onchange="recalcDates()">
                <span>1. æ­£å¸¸<br><small style="font-weight:normal; color:#666;">(è¨‚-7 / å°¾-5)</small></span>
            </label>
            <label class="ticket-option-label">
                <input type="radio" name="ticketRule" value="lcc" onchange="recalcDates()">
                <span>2. å»‰èˆª<br><small style="font-weight:normal; color:#666;">(è¨‚-15 / å°¾-5)</small></span>
            </label>
            <label class="ticket-option-label">
                <input type="radio" name="ticketRule" value="out" onchange="recalcDates()">
                <span>3. å¤–ç¸£å¸‚<br><small style="font-weight:normal; color:#666;">(è¨‚-10 / å°¾-8)</small></span>
            </label>
            <label class="ticket-option-label">
                <input type="radio" name="ticketRule" value="lcc_out" onchange="recalcDates()">
                <span>4. å»‰èˆª+å¤–ç¸£å¸‚<br><small style="font-weight:normal; color:#666;">(è¨‚-18 / å°¾-8)</small></span>
            </label>
        </div>

        <div class="grid-row">
            <div><label>å‡ºç™¼æ—¥æœŸ (è¥¿å…ƒ)</label><input type="text" id="outputDepartureDate" class="auto-field" readonly></div>
            <div><label>æ¥­å‹™å°ˆå“¡</label>
                <select id="salesSelect">
                    <option value="é™³å½¥ç™¾|0917-268665">é™³å½¥ç™¾ 0917-268665</option>
                    <option value="ç‹éº—èŠ¬|0937-019875">ç‹éº—èŠ¬ 0937-019875</option>
                    <option value="è”¡é›…ç­‘|0920-277072">è”¡é›…ç­‘ 0920-277072</option>
                    <option value="åŠ‰ç‰è–‡|0989-439193">åŠ‰ç‰è–‡ 0989-439193</option>
                </select>
            </div>
        </div>
        <div class="grid-row">
            <div><label>è¨‚é‡‘ç¥¨æœŸ (å·¥ä½œå¤©)</label><input type="text" id="outputCheckDepositDate" class="auto-field" readonly></div>
            <div><label>å°¾æ¬¾ç¥¨æœŸ (å·¥ä½œå¤©)</label><input type="text" id="outputCheckFinalDate" class="auto-field" readonly></div>
        </div>
    </div>

    <div class="btn-group">
        <button id="btnDeposit" class="btn-deposit" onclick="generate('deposit')" disabled>ğŸ“¥ ä¸‹è¼‰è¨‚é‡‘å–®</button>
        <button id="btnOp" class="btn-op" onclick="generate('op')" disabled>ğŸ“¥ ä¸‹è¼‰ä½œæ¥­é‡‘å–®</button>
    </div>
</div>

<script>
    const holidays2026 = ['2026-01-01', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-28', '2026-04-03', '2026-04-06', '2026-05-01', '2026-06-19', '2026-09-25', '2026-10-10'];

    // â˜…â˜…â˜… [NEW] è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„ Google Apps Script ç¶²å€ â˜…â˜…â˜…
    const TRACKER_URL = 'https://script.google.com/macros/s/AKfycby4PWsogyFH09g2Q3NtSeZbQrFI6by87s7Uh6dTBCSHqxCsyUIrhiDq8CkFMNDLg1Us/exec';

    window.onload = function() {
        document.getElementById('inputFillDate').valueAsDate = new Date();
        calculateTotal();
    };

    function parseRawData() {
        // ... (é€™æ®µç¶­æŒåŸæ¨£ä¸ç”¨å‹•) ...
        const raw = document.getElementById('rawInput').value;
        const match = raw.match(/[A-Z]{3}\d{2}(\d{6})[A-Z0-9]*/);
        const fullCodeMatch = raw.match(/([A-Z]{3}\d{8}[A-Z0-9]*)/);

        if (fullCodeMatch && match) {
            const fullCode = fullCodeMatch[1];
            let name = raw.replace(fullCode, '').trim().replace(/[ã€€\s]+$/, '');
            
            document.getElementById('inputGroupCode').value = fullCode;
            document.getElementById('inputGroupName').value = name;
            
            const dateStr6 = match[1];
            const y = "20" + dateStr6.substring(0, 2);
            const m = dateStr6.substring(2, 4);
            const d = dateStr6.substring(4, 6);
            document.getElementById('outputDepartureDate').value = `${y}/${m}/${d}`;
            
            recalcDates();
            checkBtnStatus();
        }
    }

    function recalcDates() {
        // ... (é€™æ®µç¶­æŒåŸæ¨£ä¸ç”¨å‹•) ...
        const depStr = document.getElementById('outputDepartureDate').value;
        if (!depStr) return;

        const depDate = new Date(depStr);
        const rule = document.querySelector('input[name="ticketRule"]:checked').value;
        
        let depositDays = 7;
        let finalDays = 5;

        if (rule === 'lcc') {
            depositDays = 15;
            finalDays = 5;
        } else if (rule === 'out') {
            depositDays = 10;
            finalDays = 8;
        } else if (rule === 'lcc_out') {
            depositDays = 18;
            finalDays = 8;
        }

        document.getElementById('outputCheckDepositDate').value = toTwDate(subtractWorkDays(depDate, depositDays));
        document.getElementById('outputCheckFinalDate').value = toTwDate(subtractWorkDays(depDate, finalDays));
    }

    function calculateTotal() {
        // ... (é€™æ®µç¶­æŒåŸæ¨£ä¸ç”¨å‹•) ...
        const adults = parseInt(document.getElementById('inputAdults').value) || 0;
        const children = parseInt(document.getElementById('inputChildren').value) || 0;
        const unit = parseInt(document.getElementById('inputDepositUnit').value) || 0;
        
        const total = adults + children;
        document.getElementById('inputPaxTotal').value = total;
        document.getElementById('outputTotalDeposit').value = (total * unit).toLocaleString();
    }

    function checkBtnStatus() {
        const hasCode = document.getElementById('inputGroupCode').value !== "";
        document.getElementById('btnDeposit').disabled = !hasCode;
        document.getElementById('btnOp').disabled = !hasCode;
    }

    function formatPax(val) {
        if (val === "" || val === null || val === undefined) return "";
        return val + "ä½";
    }

    // æ ¸å¿ƒç”Ÿæˆå‡½å¼
    function generate(type) {
        // â˜…â˜…â˜… [NEW] è§¸ç™¼ä¸Šå‚³åˆ°è¿½è¹¤ç³»çµ± â˜…â˜…â˜…
        // ç‚ºäº†é¿å…æ“‹åˆ°ä¸‹è¼‰æµç¨‹ï¼Œæˆ‘å€‘è®“å®ƒåœ¨èƒŒæ™¯åŸ·è¡Œï¼Œä¸å½±éŸ¿ä¸‹è¼‰
        uploadToTracker(); 

        const fileName = (type === 'deposit') ? 'template_deposit.docx' : 'template_op.docx';
        const outputSuffix = (type === 'deposit') ? 'è¨‚é‡‘å–®' : 'ä½œæ¥­é‡‘å–®';

        fetch(fileName)
            .then(response => {
                if (!response.ok) throw new Error(`æ‰¾ä¸åˆ° ${fileName}ï¼Œè«‹ç¢ºèªæª”æ¡ˆåœ¨åŒä¸€ç›®éŒ„ä¸‹ã€‚`);
                return response.arrayBuffer();
            })
            .then(content => {
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

                const salesVal = document.getElementById('salesSelect').value.split('|');
                const agency = document.getElementById('inputAgency').value;
                const agent = document.getElementById('inputAgent').value;
                const paxTotal = document.getElementById('inputPaxTotal').value;

                let groupName = document.getElementById('inputGroupName').value;
                if (groupName.length > 25) {
                    groupName = groupName.substring(0, 25) + "\n" + groupName.substring(25);
                }

                doc.render({
                    agency: agency,
                    agent: agent,
                    clientName: `${agency} ${agent}`, 
                    
                    paxAdult: formatPax(document.getElementById('inputAdults').value),
                    paxChild: formatPax(document.getElementById('inputChildren').value),
                    paxTotal: formatPax(paxTotal),
                    pax: formatPax(paxTotal), 

                    groupCode: document.getElementById('inputGroupCode').value,
                    groupName: groupName, 
                    date: document.getElementById('outputDepartureDate').value,
                    fillDate: toTwDateSimple(document.getElementById('inputFillDate').value),
                    airline: document.getElementById('inputAirline').value,
                    mobile: document.getElementById('inputMobile').value,
                    minPax: document.getElementById('inputMinPax').value,
                    
                    fee: document.getElementById('inputFee').value,
                    
                    depositUnit: parseInt(document.getElementById('inputDepositUnit').value).toLocaleString(),
                    totalDeposit: document.getElementById('outputTotalDeposit').value,
                    tips: document.getElementById('inputTips').value,
                    depositDeadline: document.getElementById('inputDepositDeadline').value,
                    checkDepositDate: document.getElementById('outputCheckDepositDate').value,
                    checkFinalDate: document.getElementById('outputCheckFinalDate').value,
                    remarks: document.getElementById('inputRemarks').value,
                    salesName: salesVal[0],
                    salesPhone: salesVal[1]
                });

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                
                let agencyShort = agency.replace(/æ—…è¡Œç¤¾/g, ""); 
                let fileNameString = `${document.getElementById('inputGroupCode').value}${agencyShort}${paxTotal}ä½${outputSuffix}.docx`;
                
                saveAs(out, fileNameString);
            })
            .catch(error => {
                console.error(error);
                alert("âŒ ç”Ÿæˆå¤±æ•—ï¼š\n" + error.message);
            });
    }

    // ... (subtractWorkDays, toTwDateSimple, toTwDate ç¶­æŒåŸæ¨£) ...
    function subtractWorkDays(startDate, workDays) {
        let d = new Date(startDate);
        let count = 0;
        while (count < workDays) {
            d.setDate(d.getDate() - 1);
            const day = d.getDay();
            const ymd = d.toISOString().split('T')[0];
            if (day !== 0 && day !== 6 && !holidays2026.includes(ymd)) count++;
        }
        return d;
    }

    function toTwDateSimple(dateStr) {
        const d = new Date(dateStr);
        return isNaN(d) ? "" : `${d.getFullYear()-1911}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
    }

    function toTwDate(d) {
        return `${d.getFullYear()-1911}å¹´${(d.getMonth()+1).toString().padStart(2,'0')}æœˆ${d.getDate().toString().padStart(2,'0')}æ—¥`;
    }

    // â˜…â˜…â˜… [NEW] æ–°å¢ï¼šä¸Šå‚³åˆ° Google Sheet è¿½è¹¤ç³»çµ±çš„å‡½å¼ â˜…â˜…â˜…
    function uploadToTracker() {
        // --- [æ–°å¢] å®ˆé–€å“¡é‚è¼¯é–‹å§‹ ---
        const salesRaw = document.getElementById('salesSelect').value; 
        // æª¢æŸ¥é¸å–®çš„å€¼æ˜¯å¦åŒ…å« "é™³å½¥ç™¾"
        // å¦‚æœã€Œä¸åŒ…å«ã€ï¼Œå°±ç›´æ¥çµæŸ (return)ï¼Œä¸åŸ·è¡Œå¾Œé¢çš„å‚³é€å‹•ä½œ
        if (!salesRaw.includes("é™³å½¥ç™¾")) {
            console.log("éé™³å½¥ç™¾çš„è¨‚å–®ï¼Œç•¥éä¸Šå‚³ã€‚");
            return; 
        }
        // --- [æ–°å¢] å®ˆé–€å“¡é‚è¼¯çµæŸ ---

        if (!TRACKER_URL || TRACKER_URL.includes("æ‚¨çš„ID")) {
            console.warn("å°šæœªè¨­å®šè¿½è¹¤ç³»çµ± URLï¼Œç•¥éä¸Šå‚³ã€‚");
            return;
        }

        const groupCode = document.getElementById('inputGroupCode').value;
        const agency = document.getElementById('inputAgency').value;
        const agent = document.getElementById('inputAgent').value;
        const remark = document.getElementById('inputRemarks').value;
        
        const agtCombined = `${agency} ${agent}`.trim();

        if (!groupCode) return; 

        const formData = new FormData();
        formData.append('action', 'add');
        formData.append('groupCode', groupCode);
        formData.append('agt', agtCombined);
        formData.append('remark', remark);

        fetch(TRACKER_URL, {
            method: 'POST',
            body: formData,
            mode: 'no-cors' 
        }).then(() => {
            console.log(`è¨‚å–® ${groupCode} å·²ç™¼é€è‡³è¿½è¹¤ç³»çµ±`);
        }).catch(err => {
            console.error('ä¸Šå‚³è¿½è¹¤ç³»çµ±å¤±æ•—:', err);
        });
    }
</script>
</body>
</html>