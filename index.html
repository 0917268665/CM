<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸–èˆˆ-è‡ªå‹•å¡«å–®ç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f6f9; padding: 20px; color: #333; }
        .container { max-width: 950px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        
        .section { margin-bottom: 25px; padding: 20px; background: #fff; border: 1px solid #e1e4e8; border-radius: 8px; }
        .section-title { font-weight: bold; color: #007bff; margin-bottom: 15px; font-size: 1.1em; border-left: 4px solid #007bff; padding-left: 10px; }

        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .grid-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 10px; }
        .full-width { grid-column: span 2; }

        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.95em; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 15px; }
        input:focus, textarea:focus { border-color: #007bff; outline: none; background: #f9fcff; }
        textarea { resize: vertical; height: 80px; }

        .auto-field { background-color: #e9ecef; color: #495057; cursor: not-allowed; font-weight: bold; }
        
        .btn-group { display: flex; gap: 15px; margin-top: 20px; }
        button { flex: 1; color: white; border: none; padding: 15px; font-size: 18px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }
        
        .btn-deposit { background-color: #17a2b8; }
        .btn-deposit:hover { background-color: #138496; }
        
        .btn-op { background-color: #e67e22; }
        .btn-op:hover { background-color: #d35400; }

        .tag-info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 4px; font-size: 0.9em; margin-bottom: 20px; border: 1px solid #bee5eb; }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.37.11/docxtemplater.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
</head>
<body>

<div class="container">
    <h1>âœˆï¸ ä¸–èˆˆ-è‡ªå‹•å¡«å–®ç³»çµ±</h1>

    <div class="section">
        <div class="section-title">1. å¿«é€Ÿè²¼ä¸Š (è‡ªå‹•è§£æåœ˜è™Ÿ/æ—¥æœŸ)</div>
        <textarea id="rawInput" placeholder="ç¯„ä¾‹ï¼šæ˜‡ç´šç‰ˆ~æ¸…å·...  CJJ05260206A" oninput="parseRawData()"></textarea>
    </div>

    <div class="section">
        <div class="section-title">2. è©³ç´°è³‡æ–™è¼¸å…¥</div>
        
        <div class="grid-row">
            <div><label>å¡«å–®æ—¥æœŸ</label><input type="date" id="inputFillDate"></div>
            <div><label>åœ˜è™Ÿ</label><input type="text" id="inputGroupCode" class="auto-field" readonly></div>
        </div>

        <div class="grid-row"><div class="full-width"><label>ç”¢å“åç¨±</label><input type="text" id="inputGroupName"></div></div>

        <div class="grid-row">
            <div><label>æ—…è¡Œç¤¾åç¨± ({agency})</label><input type="text" id="inputAgency" value="æ—…è¡Œç¤¾"></div>
            <div><label>AGT åå­— ({agent})</label><input type="text" id="inputAgent" value=""></div>
        </div>

        <div class="grid-row">
            <div><label>èˆªç©ºå…¬å¸</label><input type="text" id="inputAirline" value="èˆªç©º"></div>
            <div><label>è¡Œå‹•é›»è©±</label><input type="text" id="inputMobile" value=""></div>
        </div>

        <hr style="border: 0; border-top: 1px dashed #ccc; margin: 20px 0;">

        <div class="grid-row-3">
            <div><label>å¤§äººäººæ•¸ ({paxAdult})</label><input type="number" id="inputAdults" value="" min="0" oninput="calculateTotal()"></div>
            <div><label>å°å­©äººæ•¸ ({paxChild})</label><input type="number" id="inputChildren" value="" min="0" oninput="calculateTotal()"></div>
            <div><label>ç¸½äººæ•¸ ({paxTotal})</label><input type="number" id="inputPaxTotal" class="auto-field" readonly></div>
        </div>

        <div class="grid-row">
            <div><label>åœ˜è²» ({fee})</label><input type="text" id="inputFee" value=""></div>
            <div><label>æˆåœ˜é–€æª» (äºº)</label><input type="number" id="inputMinPax" value="16"></div>
        </div>

        <div class="grid-row">
            <div><label>æ¯äººè¨‚é‡‘</label><input type="number" id="inputDepositUnit" value="" oninput="calculateTotal()"></div>
            <div><label>è¨‚é‡‘ç¸½é‡‘é¡ (è‡ªå‹•è¨ˆç®—)</label><input type="text" id="outputTotalDeposit" class="auto-field" readonly></div>
        </div>

        <div class="grid-row">
            <div><label>å°è²» (æ¯äººæ¯å¤©)</label><input type="number" id="inputTips" value="300"></div>
            <div><label>è¨‚é‡‘ç¹³äº¤æœŸé™</label><input type="text" id="inputDepositDeadline" placeholder="ä¾‹: 1/15 17:00å‰"></div>
        </div>

        <div class="grid-row"><div class="full-width"><label>å‚™è¨»äº‹é …</label><textarea id="inputRemarks" placeholder="è¼¸å…¥é¡å¤–å‚™è¨»..."></textarea></div></div>
    </div>

    <div class="section">
        <div class="section-title">3. ç¥¨æœŸèˆ‡æ¥­å‹™</div>
        <div class="grid-row">
            <div><label>å‡ºç™¼æ—¥æœŸ (è¥¿å…ƒ)</label><input type="text" id="outputDepartureDate" class="auto-field" readonly></div>
            <div><label>æ¥­å‹™å°ˆå“¡</label>
                <select id="salesSelect">
                    <option value="é™³å½¥ç™¾|0917-268665">é™³å½¥ç™¾ 0917-268665</option>
                    <option value="ç‹éº—èŠ¬|0937-019875">ç‹éº—èŠ¬ 0937-019875</option>
                    <option value="è”¡é›…ç­‘|0920-277072">è”¡é›…ç­‘ 0920-277072</option>
                    <option value="åŠ‰ç‰è–‡|0989-439193">åŠ‰ç‰è–‡ 0989-439193</option>
                </select>
            </div>
        </div>
        <div class="grid-row">
            <div><label>è¨‚é‡‘ç¥¨æœŸ (å‰7å·¥ä½œå¤©)</label><input type="text" id="outputCheckDepositDate" class="auto-field" readonly></div>
            <div><label>å°¾æ¬¾ç¥¨æœŸ (å‰5å·¥ä½œå¤©)</label><input type="text" id="outputCheckFinalDate" class="auto-field" readonly></div>
        </div>
    </div>

    <div class="btn-group">
        <button id="btnDeposit" class="btn-deposit" onclick="generate('deposit')" disabled>ğŸ“¥ ä¸‹è¼‰è¨‚é‡‘å–®</button>
        <button id="btnOp" class="btn-op" onclick="generate('op')" disabled>ğŸ“¥ ä¸‹è¼‰ä½œæ¥­é‡‘å–®</button>
    </div>
</div>

<script>
    const holidays2026 = ['2026-01-01', '2026-02-16', '2026-02-17', '2026-02-18', '2026-02-19', '2026-02-20', '2026-02-28', '2026-04-03', '2026-04-06', '2026-05-01', '2026-06-19', '2026-09-25', '2026-10-10'];

    window.onload = function() {
        document.getElementById('inputFillDate').valueAsDate = new Date();
        calculateTotal();
    };

    function parseRawData() {
        const raw = document.getElementById('rawInput').value;
        const match = raw.match(/[A-Z]{3}\d{2}(\d{6})[A-Z0-9]*/);
        const fullCodeMatch = raw.match(/([A-Z]{3}\d{8}[A-Z0-9]*)/);

        if (fullCodeMatch && match) {
            const fullCode = fullCodeMatch[1];
            let name = raw.replace(fullCode, '').trim().replace(/[ã€€\s]+$/, '');
            
            document.getElementById('inputGroupCode').value = fullCode;
            document.getElementById('inputGroupName').value = name;
            calculateDates(match[1]);
            checkBtnStatus();
        }
    }

    function calculateDates(dateStr6) {
        if (dateStr6 && dateStr6.length === 6) {
            const y = "20" + dateStr6.substring(0, 2);
            const m = dateStr6.substring(2, 4);
            const d = dateStr6.substring(4, 6);
            const depDate = new Date(`${y}-${m}-${d}`);

            document.getElementById('outputDepartureDate').value = `${y}/${m}/${d}`;
            document.getElementById('outputCheckDepositDate').value = toTwDate(subtractWorkDays(depDate, 7));
            document.getElementById('outputCheckFinalDate').value = toTwDate(subtractWorkDays(depDate, 5));
        }
    }

    function calculateTotal() {
        const adults = parseInt(document.getElementById('inputAdults').value) || 0;
        const children = parseInt(document.getElementById('inputChildren').value) || 0;
        const unit = parseInt(document.getElementById('inputDepositUnit').value) || 0;
        
        const total = adults + children;
        document.getElementById('inputPaxTotal').value = total;
        document.getElementById('outputTotalDeposit').value = (total * unit).toLocaleString();
    }

    function checkBtnStatus() {
        const hasCode = document.getElementById('inputGroupCode').value !== "";
        document.getElementById('btnDeposit').disabled = !hasCode;
        document.getElementById('btnOp').disabled = !hasCode;
    }

    // æ ¼å¼åŒ–äººæ•¸ (æœ‰å€¼æ‰åŠ "ä½")
    function formatPax(val) {
        if (val === "" || val === null || val === undefined) return "";
        return val + "ä½";
    }

    // æ ¸å¿ƒç”Ÿæˆå‡½å¼
    function generate(type) {
        // è¨­å®šå°æ‡‰æª”å
        const fileName = (type === 'deposit') ? 'template_deposit.docx' : 'template_op.docx';
        const outputSuffix = (type === 'deposit') ? 'è¨‚é‡‘å–®' : 'ä½œæ¥­é‡‘å–®';

        fetch(fileName)
            .then(response => {
                if (!response.ok) throw new Error(`æ‰¾ä¸åˆ° ${fileName}ï¼Œè«‹ç¢ºèªæª”æ¡ˆåœ¨åŒä¸€ç›®éŒ„ä¸‹ã€‚`);
                return response.arrayBuffer();
            })
            .then(content => {
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

                const salesVal = document.getElementById('salesSelect').value.split('|');
                const agency = document.getElementById('inputAgency').value;
                const agent = document.getElementById('inputAgent').value;
                const paxTotal = document.getElementById('inputPaxTotal').value;

                // è™•ç†åœ˜åæ›è¡Œ
                let groupName = document.getElementById('inputGroupName').value;
                if (groupName.length > 25) {
                    groupName = groupName.substring(0, 28) + "\n" + groupName.substring(28);
                }

                doc.render({
                    // æ–°å¢æ¬„ä½
                    agency: agency,
                    agent: agent,
                    clientName: `${agency} ${agent}`, 
                    
                    // äººæ•¸ï¼šä½¿ç”¨ formatPax åˆ¤æ–·æ˜¯å¦é¡¯ç¤º "ä½"
                    paxAdult: formatPax(document.getElementById('inputAdults').value),
                    paxChild: formatPax(document.getElementById('inputChildren').value),
                    paxTotal: formatPax(paxTotal),
                    pax: formatPax(paxTotal), 

                    // åŸæœ‰æ¬„ä½
                    groupCode: document.getElementById('inputGroupCode').value,
                    groupName: groupName, 
                    date: document.getElementById('outputDepartureDate').value,
                    fillDate: toTwDateSimple(document.getElementById('inputFillDate').value),
                    airline: document.getElementById('inputAirline').value,
                    mobile: document.getElementById('inputMobile').value,
                    minPax: document.getElementById('inputMinPax').value,
                    
                    // åœ˜è²»æ”¹ç‚ºç›´æ¥è®€å–æ–‡å­—ï¼Œä¸åšæ•¸å€¼æ ¼å¼åŒ–
                    fee: document.getElementById('inputFee').value,
                    
                    depositUnit: parseInt(document.getElementById('inputDepositUnit').value).toLocaleString(),
                    totalDeposit: document.getElementById('outputTotalDeposit').value,
                    tips: document.getElementById('inputTips').value,
                    depositDeadline: document.getElementById('inputDepositDeadline').value,
                    checkDepositDate: document.getElementById('outputCheckDepositDate').value,
                    checkFinalDate: document.getElementById('outputCheckFinalDate').value,
                    remarks: document.getElementById('inputRemarks').value,
                    salesName: salesVal[0],
                    salesPhone: salesVal[1]
                });

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                
                // æª”åè¨­å®š
                let agencyShort = agency.replace(/æ—…è¡Œç¤¾/g, ""); 
                let fileNameString = `${document.getElementById('inputGroupCode').value}${agencyShort}${paxTotal}ä½${outputSuffix}.docx`;
                
                saveAs(out, fileNameString);
            })
            .catch(error => {
                console.error(error);
                alert("âŒ ç”Ÿæˆå¤±æ•—ï¼š\n" + error.message + "\n\nâš ï¸ æ³¨æ„ï¼šè‹¥æ‚¨æ˜¯ç›´æ¥é›™æ“Šæ‰“é–‹ HTMLï¼Œç€è¦½å™¨æœƒé˜»æ“‹è®€å–æœ¬æ©Ÿæª”æ¡ˆã€‚è«‹ä½¿ç”¨ Local Server é–‹å•Ÿã€‚");
            });
    }

    function subtractWorkDays(startDate, workDays) {
        let d = new Date(startDate);
        let count = 0;
        while (count < workDays) {
            d.setDate(d.getDate() - 1);
            const day = d.getDay();
            const ymd = d.toISOString().split('T')[0];
            if (day !== 0 && day !== 6 && !holidays2026.includes(ymd)) count++;
        }
        return d;
    }

    function toTwDateSimple(dateStr) {
        const d = new Date(dateStr);
        return isNaN(d) ? "" : `${d.getFullYear()-1911}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}`;
    }

    function toTwDate(d) {
        return `${d.getFullYear()-1911}å¹´${(d.getMonth()+1).toString().padStart(2,'0')}æœˆ${d.getDate().toString().padStart(2,'0')}æ—¥`;
    }
</script>

</body>
</html>