<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç®¡ç†æ§åˆ¶å°</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #f4f6f8; 
            padding: 15px; 
            max-width: 600px; 
            margin: 0 auto; 
            color: #333;
        }
        h2 { text-align: center; color: #2c3e50; margin-bottom: 25px; font-weight: 700; letter-spacing: 1px; }
        
        .loading { text-align: center; padding: 40px; color: #7f8c8d; font-size: 1.1em; }
        
        /* --- [æ–°] é ‚éƒ¨å¾…è¾¦åŒ¯ç¸½æ¡†æ¨£å¼ --- */
        .summary-box {
            background: #fff8e1; /* æ·ºé»ƒè‰²èƒŒæ™¯ */
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            box-shadow: 0 4px 10px rgba(255, 193, 7, 0.2);
            display: none; /* é è¨­éš±è—ï¼Œæœ‰è³‡æ–™æ‰é¡¯ç¤º */
        }
        .summary-title {
            font-weight: bold;
            color: #d35400;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            font-size: 1.1em;
        }
        .summary-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .summary-item {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 6px;
            border-left: 4px solid #e74c3c;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* è®“æ»‘é¼ è®Šæ‰‹å‹ */
        }
        .summary-code { font-weight: bold; color: #2c3e50; margin-right: 10px; }
        .summary-content { color: #555; flex-grow: 1; }

        /* å¡ç‰‡è¨­è¨ˆå„ªåŒ– */
        .card { 
            background: white; 
            border-radius: 16px; 
            margin-bottom: 20px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            overflow: hidden; /* è®“æ¨™é¡ŒèƒŒæ™¯ä¸æº¢å‡º */
            transition: transform 0.2s;
            border: 1px solid #eee;
        }
        
        /* ç‹€æ…‹åˆ— - åŠ å¤§é¡¯ç¤ºå€åŸŸ */
        .card-header-strip {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #fff;
            font-weight: bold;
        }
        
        /* å®Œæˆç‹€æ…‹ (ç¶ è‰²) */
        .card.done .card-header-strip {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        /* é€²è¡Œä¸­ç‹€æ…‹ (é»ƒè‰²) */
        .card.pending .card-header-strip {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            color: #fff; /* é»ƒè‰²èƒŒæ™¯é…ç™½å­— */
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .card-body { padding: 15px; }

        /* æ¨™é¡Œå€å¡Š */
        .title-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
        .group-code { font-size: 1.25em; font-weight: 800; color: #34495e; letter-spacing: 0.5px; }
        
        /* æœˆä»½é¡è‰²æ¨™ç±¤ */
        .date-badge { 
            font-size: 0.85em; 
            color: white; 
            padding: 4px 8px; 
            border-radius: 6px; 
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .agt { 
            font-size: 0.85em; 
            color: #555; 
            background: #fff; 
            padding: 4px 10px; 
            border-radius: 20px; 
            white-space: nowrap; 
            opacity: 0.9;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* è³‡è¨Šåˆ— */
        .info-row { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 15px; 
            font-size: 0.95em; 
            color: #555; 
            background: #f8f9fa; 
            padding: 8px 12px; 
            border-radius: 8px; 
            align-items: center;
        }
        .info-item { display: flex; align-items: center; gap: 6px; }

        /* æ ¼ç‹€é–‹é—œå€ - ç¾åŒ–æŒ‰éˆ• */
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        
        .checkbox-wrapper { position: relative; }
        .checkbox-wrapper input { position: absolute; opacity: 0; cursor: pointer; height: 0; width: 0; }
        
        /* è‡ªå®šç¾© Checkbox æ¨£å¼ */
        .checkbox-label {
            display: flex;
            align-items: center;
            background: #fff;
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95em;
            color: #7f8c8d;
        }
        
        /* å‹¾é¸æ™‚çš„æ¨£å¼ */
        .checkbox-wrapper input:checked + .checkbox-label {
            border-color: #3498db;
            background-color: #ebf5fb;
            color: #2980b9;
            font-weight: 600;
        }
        
        /* å‹¾å‹¾åœ–ç¤º */
        .checkbox-label::before {
            content: '';
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 8px;
            border-radius: 4px;
            border: 2px solid #ccc;
            background: white;
            transition: all 0.2s;
        }
        .checkbox-wrapper input:checked + .checkbox-label::before {
            background-color: #3498db;
            border-color: #3498db;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white' width='14px' height='14px'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z'/%3E%3C/svg%3E");
            background-position: center;
            background-repeat: no-repeat;
        }

        /* è¼¸å…¥æ¡†å€åŸŸ */
        .input-group { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; }

        /* å‚™è¨»æ¬„ */
        .remark-input { 
            width: 100%; 
            padding: 10px 12px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            font-size: 0.95em; 
            box-sizing: border-box; 
            background: #fafafa;
            transition: border 0.3s; 
        }
        .remark-input:focus { border-color: #3498db; outline: none; background: #fff; }

        /* [æ–°] å¾…è¾¦äº‹é …æ¬„ (ç´…è‰²ç³»ï¼Œå¼·èª¿) */
        .todo-input { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ffccd5; /* æ·ºç´…æ¡† */
            border-radius: 8px; 
            font-size: 0.95em; 
            box-sizing: border-box; 
            background: #fff0f3; /* æ·ºç´…åº• */
            color: #c0392b;
        }
        .todo-input:focus { border-color: #e74c3c; outline: none; background: #fff; }
        .todo-input::placeholder { color: #e6b0aa; }

        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: rgba(50, 50, 50, 0.9); color: white; padding: 12px 24px; border-radius: 30px; font-size: 0.95em; opacity: 0; transition: all 0.3s; pointer-events: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body>

    <div id="summary-box" class="summary-box">
        <div class="summary-title">ğŸ”¥ å¾…è¾¦äº‹é …æ¸…å–®</div>
        <ul id="summary-list" class="summary-list">
            </ul>
    </div>

    <h2>âœˆï¸ è¨‚å–®ç®¡ç†æ§åˆ¶å°</h2>
    <div id="order-list">
        <div class="loading">æ­£åœ¨è®€å–é›²ç«¯è³‡æ–™...</div>
    </div>
    <div id="toast" class="toast">å·²å„²å­˜è®Šæ›´</div>

<script>
    // â˜…â˜…â˜… æ‚¨çš„ GAS ç¶²å€ â˜…â˜…â˜…
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby4PWsogyFH09g2Q3NtSeZbQrFI6by87s7Uh6dTBCSHqxCsyUIrhiDq8CkFMNDLg1Us/exec'; 

    fetch(GAS_URL)
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById('order-list');
        const summaryBox = document.getElementById('summary-box');
        const summaryList = document.getElementById('summary-list');
        
        container.innerHTML = ''; 
        summaryList.innerHTML = ''; // æ¸…ç©ºåŒ¯ç¸½æ¸…å–®
        
        let hasTodo = false; // æ¨™è¨˜æ˜¯å¦æœ‰å¾…è¾¦

        // â˜…â˜…â˜… æ–°ç‰ˆæ’åºé‚è¼¯ â˜…â˜…â˜…
        data.sort((a, b) => {
            // è§£æå™¨ï¼šå›å‚³ { date: æ•¸å­—æ—¥æœŸ, suffix: å°¾ç¢¼å­—ä¸² }
            const parseCode = (code) => {
                // æŠ“å–æœ€å¾Œé¢çš„6ä½æ•¸å­—(æ—¥æœŸ) + å‰©ä¸‹çš„å°¾ç¢¼
                const match = code.match(/(\d{6})([A-Z]*)$/);
                if (match) {
                    return { 
                        date: parseInt(match[1]), 
                        suffix: match[2] || '' 
                    };
                }
                return { date: 999999, suffix: '' }; // æŠ“ä¸åˆ°æ—¥æœŸçš„æ’æœ€å¾Œ
            };

            const infoA = parseCode(a.groupCode);
            const infoB = parseCode(b.groupCode);

            // 1. å…ˆæ¯”æ—¥æœŸ (å° -> å¤§)
            if (infoA.date !== infoB.date) {
                return infoA.date - infoB.date; 
            }
            
            // 2. æ—¥æœŸä¸€æ¨£ï¼Œæ¯”å°¾ç¢¼ (A -> B -> C)
            return infoA.suffix.localeCompare(infoB.suffix);
        });

        if (data.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">ç›®å‰æ²’æœ‰è¨‚å–®</div>';
            return;
        }

        data.forEach(order => {
            // --- [æ–°] è™•ç†åŒ¯ç¸½é‚è¼¯ ---
            if (order.todo && order.todo.trim() !== "") {
                hasTodo = true;
                const li = document.createElement('li');
                li.className = 'summary-item';
                // é»æ“ŠåŒ¯ç¸½é …ç›®æœƒè‡ªå‹•æ²å‹•åˆ°è©²å¡ç‰‡
                li.innerHTML = `
                    <span class="summary-code">${order.groupCode}</span>
                    <span class="summary-content">${order.todo}</span>
                `;
                li.onclick = () => {
                    const card = document.getElementById(`card-${order.groupCode}`);
                    if(card) {
                        card.scrollIntoView({behavior: "smooth", block: "center"});
                        // åŠ å€‹é–ƒçˆæ•ˆæœæé†’ç”¨æˆ¶
                        card.style.transition = "transform 0.2s";
                        card.style.transform = "scale(1.02)";
                        setTimeout(() => card.style.transform = "scale(1)", 300);
                    }
                };
                summaryList.appendChild(li);
            }

            // --- ç”¢ç”Ÿå¡ç‰‡ ---
            const card = document.createElement('div');
            card.id = `card-${order.groupCode}`; // è¨­å®š ID æ–¹ä¾¿è·³è½‰
            
            // è§£ææ—¥æœŸèˆ‡æœˆä»½ (ç”¨æ–¼é¡è‰²)
            let dateDisplay = '';
            let monthColor = '#95a5a6'; // é è¨­ç°
            
            const match = order.groupCode.match(/(\d{6})([A-Z]*)$/);
            if(match) {
                const fullDate = match[1]; // 260111
                const month = fullDate.substring(2,4); // 01
                const day = fullDate.substring(4,6);   // 11
                dateDisplay = `${month}/${day}`;
                monthColor = getMonthColor(month);
            }

            // åˆ¤æ–·ç‹€æ…‹æ–‡å­—
            const allDone = checkAllDone(order);
            const statusText = allDone ? 'å·²å®Œæˆ' : 'é€²è¡Œä¸­';
            const statusClass = allDone ? 'done' : 'pending';
            card.className = `card ${statusClass}`;

            const phoneDisplay = order.phone ? `<a href="tel:${order.phone}" style="color:#555;text-decoration:none;font-weight:bold;">${order.phone}</a>` : '<span style="color:#bbb;">ç„¡</span>';

            card.innerHTML = `
                <div class="card-header-strip">
                    <span>${statusText}</span>
                    <span class="agt">${order.agt}</span>
                </div>

                <div class="card-body">
                    <div class="title-row">
                        ${dateDisplay ? `<span class="date-badge" style="background:${monthColor}">${dateDisplay}</span>` : ''}
                        <span class="group-code">${order.groupCode}</span>
                    </div>

                    <div class="info-row">
                        <div class="info-item">
                            ğŸ‘¥ <b>${order.pax || 0}</b> äºº
                        </div>
                        <div class="info-item" style="margin-left:auto;">
                            ğŸ“ ${phoneDisplay}
                        </div>
                    </div>

                    <div class="grid-options">
                        ${renderCheckbox(order.groupCode, 'ticket', 'é–‹ç¥¨é€šçŸ¥', order.ticket)}
                        ${renderCheckbox(order.groupCode, 'passport', 'è­·ç…§åå–®', order.passport)}
                        ${renderCheckbox(order.groupCode, 'contract_sent', 'åˆç´„çµ¦é', order.contract_sent)}
                        ${renderCheckbox(order.groupCode, 'contract_back', 'åˆç´„æ”¶å›', order.contract_back)}
                        ${renderCheckbox(order.groupCode, 'confirm', 'ç¢ºèªå–®ç¹³', order.confirm)}
                        ${renderCheckbox(order.groupCode, 'transfer', 'ä»£è½‰é–‹ç«‹', order.transfer)}
                    </div>

                    <div class="input-group">
                        <input type="text" class="todo-input" 
                               value="${order.todo || ''}" 
                               placeholder="âš ï¸ å¾…è¾¦äº‹é … (è¼¸å…¥å¾Œä¸Šæ–¹è‡ªå‹•é¡¯ç¤º)" 
                               onchange="updateText('${order.groupCode}', 'todo', this.value)">

                        <input type="text" class="remark-input" 
                               value="${order.remark || ''}" 
                               placeholder="å‚™è¨»..." 
                               onchange="updateText('${order.groupCode}', 'remark', this.value)">
                    </div>
                </div>
            `;
            container.appendChild(card);
        });

        // å¦‚æœæœ‰å¾…è¾¦äº‹é …ï¼Œé¡¯ç¤ºåŒ¯ç¸½æ¡†
        if (hasTodo) {
            summaryBox.style.display = 'block';
        } else {
            summaryBox.style.display = 'none';
        }
    })
    .catch(err => {
        console.error(err);
        document.getElementById('order-list').innerHTML = '<div style="color:red; text-align:center;">è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
    });

    // â˜…â˜…â˜… æœˆä»½é¡è‰²å®šç¾© â˜…â˜…â˜…
    function getMonthColor(month) {
        const colors = {
            '01': '#E74C3C', // ç´…
            '02': '#E67E22', // æ©˜
            '03': '#F1C40F', // é»ƒ
            '04': '#2ECC71', // ç¶ 
            '05': '#1ABC9C', // é’
            '06': '#3498DB', // è—
            '07': '#9B59B6', // ç´«
            '08': '#34495E', // æ·±è—ç°
            '09': '#D35400', // æ·±æ©˜
            '10': '#7F8C8D', // ç°
            '11': '#27AE60', // æ·±ç¶ 
            '12': '#C0392B'  // æ·±ç´…
        };
        return colors[month] || '#95a5a6';
    }

    function renderCheckbox(groupCode, field, label, isChecked) {
        return `
            <div class="checkbox-wrapper">
                <input type="checkbox" id="${groupCode}-${field}" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="updateStatus('${groupCode}', '${field}', this.checked, this)">
                <label class="checkbox-label" for="${groupCode}-${field}">${label}</label>
            </div>
        `;
    }

    function updateStatus(groupCode, field, isChecked, checkboxEl) {
        showToast('å„²å­˜ä¸­...');
        const card = checkboxEl.closest('.card');
        
        // å‰ç«¯å³æ™‚æ›´æ–° UI (è®Šè‰²)
        const allDone = checkCardCompletion(card);
        updateCardHeader(card, allDone);

        const formData = new FormData();
        formData.append('action', 'update');
        formData.append('groupCode', groupCode);
        formData.append('field', field);
        formData.append('value', isChecked);

        fetch(GAS_URL, { method: 'POST', body: formData, mode: 'no-cors' })
        .then(() => showToast('âœ… å·²å„²å­˜'))
        .catch(() => showToast('âŒ å„²å­˜å¤±æ•—'));
    }

    // æ•´åˆæ›´æ–°æ–‡å­—åŠŸèƒ½ (å‚™è¨» & å¾…è¾¦)
    function updateText(groupCode, field, value) {
        showToast('å„²å­˜ä¸­...');
        const formData = new FormData();
        formData.append('action', 'update');
        formData.append('groupCode', groupCode);
        formData.append('field', field);
        formData.append('value', value);

        fetch(GAS_URL, { method: 'POST', body: formData, mode: 'no-cors' })
        .then(() => {
            showToast('âœ… å·²æ›´æ–°');
            // å¦‚æœæ”¹çš„æ˜¯å¾…è¾¦äº‹é …ï¼Œç°¡å–®æç¤ºç”¨æˆ¶
            if(field === 'todo') {
               setTimeout(() => alert('å¾…è¾¦äº‹é …å·²æ›´æ–°ï¼è«‹é‡æ–°æ•´ç†é é¢ä»¥æŸ¥çœ‹ä¸Šæ–¹åŒ¯ç¸½ã€‚'), 500);
            }
        })
        .catch(() => showToast('âŒ å¤±æ•—'));
    }

    function checkAllDone(order) {
        return order.ticket && order.passport && order.contract_sent && 
               order.contract_back && order.confirm && order.transfer;
    }

    // å‰ç«¯æª¢æŸ¥ DOM ç‹€æ…‹
    function checkCardCompletion(card) {
        const checkboxes = card.querySelectorAll('input[type="checkbox"]');
        let allChecked = true;
        checkboxes.forEach(cb => { if (!cb.checked) allChecked = false; });
        return allChecked;
    }

    function updateCardHeader(card, isDone) {
        card.className = isDone ? 'card done' : 'card pending';
        const headerText = card.querySelector('.card-header-strip span:first-child');
        if(headerText) headerText.innerText = isDone ? 'å·²å®Œæˆ' : 'é€²è¡Œä¸­';
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }
</script>
</body>
</html>