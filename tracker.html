<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®ç®¡ç†æ§åˆ¶å°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: #f0f2f5; padding: 15px; max-width: 600px; margin: 0 auto; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .loading { text-align: center; padding: 20px; color: #666; }
        
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-top: 5px solid #ccc; transition: all 0.3s ease; }
        .card.done { border-top-color: #2ecc71; } /* å®Œæˆè®Šç¶ è‰² */
        .card.pending { border-top-color: #f1c40f; } /* é€²è¡Œä¸­é»ƒè‰² */

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .group-code { font-size: 1.1em; font-weight: bold; color: #2c3e50; letter-spacing: 0.5px; }
        .date-badge { font-size: 0.8em; color: white; background: #3498db; padding: 2px 6px; border-radius: 4px; margin-right: 5px;}
        .agt { font-size: 0.9em; color: #555; background: #ecf0f1; padding: 2px 8px; border-radius: 10px; }

        /* æ ¼ç‹€é–‹é—œå€ */
        .grid-options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .checkbox-wrapper { display: flex; align-items: center; background: #fafafa; padding: 8px; border-radius: 6px; border: 1px solid #eee; }
        .checkbox-wrapper input { margin-right: 8px; transform: scale(1.2); cursor: pointer; }
        .checkbox-wrapper label { font-size: 0.9em; color: #444; cursor: pointer; width: 100%; }
        
        /* å‚™è¨»æ¬„ */
        .remark-area { margin-top: 12px; }
        .remark-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9em; box-sizing: border-box; transition: border 0.3s; }
        .remark-input:focus { border-color: #3498db; outline: none; }

        /* æ›´æ–°æç¤º */
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 20px; font-size: 0.9em; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <h2>ğŸ“‹ è¨‚å–®ç®¡ç†æ§åˆ¶å°</h2>
    <div id="order-list">
        <div class="loading">æ­£åœ¨è®€å–æœ€æ–°è³‡æ–™...</div>
    </div>
    
    <div id="toast" class="toast">å·²å„²å­˜è®Šæ›´</div>

<script>
    // â˜…â˜…â˜… è«‹ç¢ºèªé€™è£¡é‚„æ˜¯æ‚¨æ­£ç¢ºçš„ GAS ç¶²å€ (éœ€ /exec çµå°¾) â˜…â˜…â˜…
    const GAS_URL = 'https://script.google.com/macros/s/AKfycby4PWsogyFH09g2Q3NtSeZbQrFI6by87s7Uh6dTBCSHqxCsyUIrhiDq8CkFMNDLg1Us/exec'; 

    fetch(GAS_URL)
    .then(res => res.json())
    .then(data => {
        const container = document.getElementById('order-list');
        container.innerHTML = ''; 

        // â˜…â˜…â˜… è‡ªå‹•æ’åºé‚è¼¯ â˜…â˜…â˜…
        // æ ¹æ“šåœ˜è™Ÿä¸­çš„æ—¥æœŸ (ç¬¬4-9ç¢¼) é€²è¡Œæ’åº
        data.sort((a, b) => {
            const getSortDate = (code) => {
                // å˜—è©¦æŠ“å– 6ä½æ•¸æ—¥æœŸ (ä¾‹å¦‚ KHH260123...)
                const match = code.match(/[A-Z0-9]{3}(\d{6})/); 
                if (match) return parseInt(match[1]); 
                return 0; // æŠ“ä¸åˆ°æ—¥æœŸçš„æ”¾æœ€å¾Œ
            };
            return getSortDate(a.groupCode) - getSortDate(b.groupCode);
        });

        if (data.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰è¨‚å–®</div>';
            return;
        }

        data.forEach(order => {
            const card = document.createElement('div');
            updateCardStyle(card, order); // è¨­å®šé¡è‰²

            // è§£ææ—¥æœŸé¡¯ç¤ºç”¨
            let dateDisplay = '';
            const match = order.groupCode.match(/[A-Z0-9]{3}(\d{6})/);
            if(match) {
                const d = match[1];
                dateDisplay = `<span class="date-badge">${d.substring(2,4)}/${d.substring(4,6)}</span>`;
            }

            card.innerHTML = `
                <div class="header">
                    <div>
                        ${dateDisplay}
                        <span class="group-code">${order.groupCode}</span>
                    </div>
                    <span class="agt">${order.agt}</span>
                </div>

                <div class="grid-options">
                    ${renderCheckbox(order.groupCode, 'ticket', 'é–‹ç¥¨é€šçŸ¥', order.ticket)}
                    ${renderCheckbox(order.groupCode, 'passport', 'è­·ç…§åå–®', order.passport)}
                    ${renderCheckbox(order.groupCode, 'contract_sent', 'åˆç´„çµ¦é', order.contract_sent)}
                    ${renderCheckbox(order.groupCode, 'contract_back', 'åˆç´„æ”¶å›', order.contract_back)}
                    ${renderCheckbox(order.groupCode, 'confirm', 'ç¢ºèªå–®ç¹³', order.confirm)}
                    ${renderCheckbox(order.groupCode, 'transfer', 'ä»£è½‰é–‹ç«‹', order.transfer)}
                </div>

                <div class="remark-area">
                    <input type="text" class="remark-input" 
                           value="${order.remark}" 
                           placeholder="è¼¸å…¥å‚™è¨»..." 
                           onchange="updateRemark('${order.groupCode}', this.value)">
                </div>
            `;
            container.appendChild(card);
        });
    })
    .catch(err => {
        console.error(err);
        document.getElementById('order-list').innerHTML = '<div style="color:red; text-align:center;">è®€å–å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†</div>';
    });

    // ç”¢ç”Ÿæ ¸å–æ–¹å¡Šçš„è¼”åŠ©å‡½å¼
    function renderCheckbox(groupCode, field, label, isChecked) {
        return `
            <div class="checkbox-wrapper">
                <input type="checkbox" id="${groupCode}-${field}" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="updateStatus('${groupCode}', '${field}', this.checked, this)">
                <label for="${groupCode}-${field}">${label}</label>
            </div>
        `;
    }

    // æ›´æ–°ç‹€æ…‹ (æ‰“å‹¾/å–æ¶ˆ)
    function updateStatus(groupCode, field, isChecked, checkboxEl) {
        showToast('å„²å­˜ä¸­...');
        
        // 1. å…ˆå³æ™‚è®Šæ›´å¡ç‰‡é¡è‰² (ä½¿ç”¨è€…é«”é©—è¼ƒå¥½)
        const card = checkboxEl.closest('.card');
        checkCardCompletion(card);

        // 2. èƒŒæ™¯å‚³é€çµ¦ Google Sheet
        const formData = new FormData();
        formData.append('action', 'update');
        formData.append('groupCode', groupCode);
        formData.append('field', field);
        formData.append('value', isChecked);

        fetch(GAS_URL, { method: 'POST', body: formData, mode: 'no-cors' })
        .then(() => showToast('âœ… å·²å„²å­˜'))
        .catch(() => showToast('âŒ å„²å­˜å¤±æ•—'));
    }

    // æ›´æ–°å‚™è¨»
    function updateRemark(groupCode, value) {
        showToast('å„²å­˜å‚™è¨»ä¸­...');
        
        const formData = new FormData();
        formData.append('action', 'update');
        formData.append('groupCode', groupCode);
        formData.append('field', 'remark');
        formData.append('value', value);

        fetch(GAS_URL, { method: 'POST', body: formData, mode: 'no-cors' })
        .then(() => showToast('âœ… å‚™è¨»å·²æ›´æ–°'))
        .catch(() => showToast('âŒ æ›´æ–°å¤±æ•—'));
    }

    // å‰ç«¯æª¢æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ (ç”¨ä¾†è®Šæ›´å¡ç‰‡é¡è‰²)
    function checkCardCompletion(card) {
        const checkboxes = card.querySelectorAll('input[type="checkbox"]');
        let allChecked = true;
        checkboxes.forEach(cb => {
            if (!cb.checked) allChecked = false;
        });

        if (allChecked) {
            card.className = 'card done';
        } else {
            card.className = 'card pending';
        }
    }

    // åˆå§‹è¼‰å…¥æ™‚è¨­å®šæ¨£å¼
    function updateCardStyle(card, order) {
        // æª¢æŸ¥ order ç‰©ä»¶è£¡çš„æ‰€æœ‰ç‹€æ…‹
        const allDone = order.ticket && order.passport && order.contract_sent && 
                        order.contract_back && order.confirm && order.transfer;
        card.className = allDone ? 'card done' : 'card pending';
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }
</script>

</body>
</html>